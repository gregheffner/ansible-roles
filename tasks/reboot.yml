---
# System reboot tasks

- name: Check if reboot is required (Debian/Ubuntu)
  stat:
    path: /var/run/reboot-required
  register: reboot_required_debian
  when: ansible_os_family == "Debian"

- name: Reboot system (legacy method)
  shell: systemctl reboot -i
  ignore_errors: true
  become: true
  when: 
    - force_reboot | default(false)
    - reboot_method | default('legacy') == 'legacy'
  async: 1
  poll: 0

- name: Reboot and wait for system to come back
  reboot:
    reboot_timeout: "{{ reboot_timeout | default(600) }}"
    connect_timeout: "{{ connect_timeout | default(20) }}"
    test_command: whoami
  become: true
  when: 
    - perform_reboot | default(false)
    - reboot_method | default('modern') == 'modern'

- name: Run post-reboot script if specified
  shell: |
    cd {{ post_reboot_script_path | dirname }}
    source {{ post_reboot_script_path | basename }}
  when: 
    - post_reboot_script_path is defined
    - post_reboot_script_path != ""
  register: post_reboot_result
  ignore_errors: true

- name: Display post-reboot script result
  debug:
    msg: "Post-reboot script executed: {{ 'SUCCESS' if post_reboot_result.rc == 0 else 'FAILED' }}"
  when: 
    - post_reboot_script_path is defined
    - post_reboot_result is defined